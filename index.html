<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Vem jobbar idag?</title>

  <!-- Fullscreen / PWA meta tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Vem jobbar?">
  <meta name="theme-color" content="#0d0d1a">

  <!-- App Icons -->
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json">

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Application Styles -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/schedule.css">
  <link rel="stylesheet" href="css/editors.css">
  <link rel="stylesheet" href="css/fridagsnyckel.css">
  <link rel="stylesheet" href="css/viktiga-datum.css">
  <link rel="stylesheet" href="css/shadow.css">
  <link rel="stylesheet" href="css/dagvy.css">
  <link rel="stylesheet" href="css/departure.css">
  <link rel="stylesheet" href="css/aw-mode.css">
  <link rel="stylesheet" href="css/animations.css">
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-header">
        <h1 class="login-title">Vem jobbar idag?</h1>
        <p class="login-subtitle">Logga in fÃ¶r att fortsÃ¤tta</p>
      </div>

      <div class="login-form">
        <div class="input-group">
          <span class="input-icon">ğŸ”’</span>
          <input type="password" class="password-input" id="passwordInput" placeholder="Ange lÃ¶senord" autocomplete="current-password">
        </div>

        <button class="login-btn" id="loginBtn">Logga in</button>

        <div class="login-loading" id="loginLoading">
          <div class="spinner"></div>
          <span>Ansluter...</span>
        </div>

        <p class="login-error" id="loginError"></p>
      </div>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Menu -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Meny</span>
      <button class="sidebar-close" id="closeSidebar">Ã—</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" data-page="schedule" id="menuTodayLink"><span class="icon">ğŸ“…</span> Dagens schema</a></li>
      <li><a href="#" data-page="monthly"><span class="icon">ğŸ—“ï¸</span> Schema</a></li>
      <li><a href="#" data-page="shadow"><span class="icon">ğŸ‘»</span> Skuggschema</a></li>
      <li><a href="#" data-page="departure"><span class="icon">ğŸš†</span> AvgÃ¥ng/Ankomst</a></li>
      <li><a href="#" data-page="upload"><span class="icon">ğŸ“¤</span> Ladda upp schema</a></li>
      <li><a href="#" data-page="settings"><span class="icon">âš™ï¸</span> InstÃ¤llningar</a></li>
    </ul>
  </nav>

  <!-- Header -->
  <header class="header">
    <button class="menu-btn" id="menuBtn">â˜°</button>
    <h1 class="header-title">Vem jobbar idag?</h1>
    <div class="sync-icon" id="syncIcon" title="Anslutningsstatus">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
        <path d="M3 3v5h5"/>
        <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
        <path d="M16 16h5v5"/>
      </svg>
    </div>
  </header>

  <!-- Main Content - Schedule Page -->
  <main class="main-content page active" id="schedulePage">
    <!-- Date Picker -->
    <div class="date-picker">
      <button class="date-nav-btn" id="prevDay">â†</button>
      <div class="date-display" id="dateDisplayBtn">
        <span id="currentDate">Tis 3 feb 2026</span>
        <input type="date" id="nativeDatePicker" class="native-date-picker">
      </div>
      <button class="date-nav-btn" id="nextDay">â†’</button>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="working-count">
        <span class="icon">ğŸ‘¥</span>
        <span class="count" id="workingCount">0</span>
        <span>arbetar</span>
      </div>
      <label class="filter-toggle">
        <input type="checkbox" id="showLediga">
        <span class="toggle-switch"></span>
        <span class="toggle-label">Lediga</span>
      </label>
    </div>

    <!-- Employee List -->
    <div class="employee-list" id="employeeList">
      <!-- Cards will be rendered here -->
    </div>
    <div class="dagvy-timestamp" id="dagvyTimestamp"></div>
  </main>

  <!-- Monthly Schedule Page -->
  <main class="monthly-page page" id="monthlyPage">
    <!-- Person List View -->
    <div id="personListView">
      <div class="person-list" id="personList">
        <!-- Person name cards will be rendered here -->
      </div>
    </div>

    <!-- Person Schedule View (hidden by default) -->
    <div id="personScheduleView" style="display: none;">
      <!-- Month Picker -->
      <div class="month-picker">
        <button class="date-nav-btn" id="prevMonth">â†</button>
        <div class="month-display clickable" id="monthDisplay" onclick="openMonthPicker()">Januari 2026</div>
        <button class="date-nav-btn" id="nextMonth">â†’</button>
      </div>

      <!-- Action Buttons -->
      <div class="schedule-action-btns">
        <button class="export-calendar-btn" id="exportCalBtn">
          <img src="https://pfst.cf2.poecdn.net/base/image/7e32cd6dbe37a1833692c5ec8ed62b3a45812a216a3de7cd897ee63e18640571?w=200&h=200" alt="" class="export-icon">
          <span>Exportera</span>
        </button>
        <button class="holidays-btn" id="holidaysBtn">
          <span>Helgdagar</span>
        </button>
      </div>

      <!-- Holidays Modal -->
      <div class="holidays-modal" id="holidaysModal">
        <div class="holidays-header">
          <h3>Helgdagar 2026</h3>
          <button class="holidays-close" id="holidaysClose">Ã—</button>
        </div>
        <div class="holidays-list" id="holidaysList">
          <!-- Holidays will be rendered here -->
        </div>
      </div>

      <!-- Person Schedule -->
      <div id="monthlyScheduleList">
        <!-- Person schedule calendar/list will be rendered here -->
      </div>
    </div>
  </main>

  <!-- Upload Page -->
  <main class="upload-page page" id="uploadPage">
    <!-- Upload Zone -->
    <div class="upload-zone" id="uploadZone">
      <span class="upload-icon">ğŸ“„</span>
      <h3>Ladda upp ditt schema</h3>
      <p>Dra och slÃ¤pp din fil hÃ¤r, eller klicka fÃ¶r att vÃ¤lja</p>
      <span class="file-formats">PDF, CSV eller JSON</span>
      <span class="browse-btn">VÃ¤lj fil</span>
      <input type="file" id="fileInput" accept=".pdf,.csv,.json,application/pdf,text/csv,application/json">
    </div>

    <!-- File Preview -->
    <div class="file-preview" id="filePreview">
      <div class="file-icon">ğŸ“„</div>
      <div class="file-info">
        <div class="file-name" id="fileName">schema.pdf</div>
        <div class="file-size" id="fileSize">2.4 MB</div>
      </div>
      <button class="remove-file" id="removeFile">Ã—</button>
    </div>

    <!-- Upload Button -->
    <button class="process-btn" id="processBtn">
      <span>ğŸ“¤</span>
      <span>Ladda upp</span>
    </button>

    <!-- Processing State -->
    <div class="processing-state" id="processingState">
      <div class="spinner"></div>
      <p id="processingText">LÃ¤ser in PDF...</p>
    </div>
  </main>

  <!-- Shadow Schedule Page -->
  <main class="shadow-page page" id="shadowPage">
    <!-- Person selector -->
    <div id="shadowPersonSelect">
      <div class="person-list" id="shadowPersonList">
        <!-- Person cards rendered here -->
      </div>
    </div>

    <!-- Shadow schedule view (hidden until person selected) -->
    <div id="shadowScheduleView" style="display: none;">
      <div class="shadow-header">
        <button class="shadow-back-btn" id="shadowBackBtn">â† Tillbaka</button>
        <div class="shadow-person-info">
          <span class="shadow-person-name" id="shadowPersonName"></span>
          <span class="shadow-cycle-badge" id="shadowCycleBadge"></span>
        </div>
      </div>
      <div class="shadow-table-container" id="shadowTableContainer">
        <!-- Shadow schedule table rendered here -->
      </div>
    </div>
  </main>

  <!-- Departure/Arrival Page -->
  <main class="departure-page page" id="departurePage">
    <div class="departure-controls">
      <select class="departure-select" id="departureStation">
        <option value="Ml" selected>MalmÃ¶ C</option>
        <option value="Hie">Hyllie</option>
        <option value="Tri">Triangeln</option>
        <option value="Lu">Lund C</option>
        <option value="Klv">KÃ¤vlinge</option>
        <option value="Lkr">Landskrona</option>
        <option value="Hb">Helsingborg C</option>
        <option value="Ã…p">Ã…storp</option>
        <option value="Elv">EslÃ¶v</option>
        <option value="HÃ¶r">HÃ¶Ã¶r</option>
        <option value="Hm">HÃ¤ssleholm C</option>
        <option value="Kr">Kristianstad C</option>
        <option value="Tb">Trelleborg</option>
        <option value="Ys">Ystad</option>
        <option value="Sim">Simrishamn</option>
        <option value="G">GÃ¶teborg C</option>
        <option value="Cst">Stockholm C</option>
      </select>
      <div class="departure-toggle">
        <button class="dep-toggle-btn active" id="depToggleAvgang" data-type="Avgang">AvgÃ¥ng</button>
        <button class="dep-toggle-btn" id="depToggleAnkomst" data-type="Ankomst">Ankomst</button>
      </div>
    </div>
    <div class="departure-board" id="departureBoard">
      <div class="departure-board-title" id="departureBoardTitle">AvgÃ¥ende tÃ¥g frÃ¥n MalmÃ¶ C</div>
      <table class="departure-table">
        <thead>
          <tr>
            <th>Tid</th>
            <th>Till</th>
            <th>Ny tid</th>
            <th>SpÃ¥r</th>
            <th>TÃ¥g</th>
            <th>AnmÃ¤rkning</th>
          </tr>
        </thead>
        <tbody id="departureTableBody">
          <!-- Rows rendered here by JS -->
        </tbody>
      </table>
    </div>
    <div class="departure-status" id="departureStatus"></div>
  </main>

  <!-- Settings Page -->
  <main class="settings-page page" id="settingsPage">
    <div class="settings-container">
      <!-- Viktiga datum (collapsible) - HÃ–GST UPP -->
      <div class="settings-section collapsible" id="importantDatesSection">
        <div class="collapsible-header" id="importantDatesHeader">
          <h3 class="settings-title" style="margin-bottom: 0;">ğŸ“Œ Viktiga datum</h3>
          <span class="collapsible-arrow">â€º</span>
        </div>
        <div class="collapsible-content" id="importantDatesContent">
          <!-- Add new date form -->
          <div class="important-date-form" id="importantDateForm">
            <div class="form-group">
              <label class="form-label">Rubrik</label>
              <input type="text" class="form-input" id="importantDateTitle" placeholder="T.ex. MÃ¶te">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Datum</label>
                <input type="date" class="form-input" id="importantDateDate">
              </div>
              <div class="form-group">
                <label class="form-label">Tid (valfritt)</label>
                <input type="time" class="form-input" id="importantDateTime">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Beskrivning (valfritt)</label>
              <textarea class="form-textarea" id="importantDateDesc" placeholder="T.ex. VÃ¤gvÃ¤gen 10, ta med laptop" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Bild (valfritt)</label>
              <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('importantDateImage').click()">
                <input type="file" accept="image/*" id="importantDateImage" style="display:none" onchange="handleImagePreview(this)">
                <div class="image-upload-placeholder" id="imageUploadPlaceholder">
                  <span>ğŸ“·</span> Tryck fÃ¶r att vÃ¤lja bild
                </div>
                <div class="image-upload-preview" id="imageUploadPreview" style="display:none">
                  <img id="imagePreviewImg" alt="FÃ¶rhandsgranskning">
                  <button type="button" class="image-remove-btn" onclick="event.stopPropagation(); removeImagePreview()">âœ•</button>
                </div>
              </div>
            </div>
            <button class="important-date-add-btn" onclick="addImportantDate()">
              <span>â•</span> LÃ¤gg till datum
            </button>
          </div>

          <!-- Saved dates (collapsible sub-section) -->
          <div class="important-dates-sub collapsible" id="savedDatesSection">
            <div class="collapsible-sub-header" id="savedDatesHeader">
              <span class="saved-dates-title">ğŸ“‹ Inlagda datum</span>
              <span class="saved-dates-count" id="savedDatesCount">0</span>
              <span class="collapsible-arrow">â€º</span>
            </div>
            <div class="collapsible-sub-content" id="savedDatesContent">
              <div class="important-dates-list" id="importantDatesList">
                <!-- Saved dates will be rendered here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Utseende (collapsible, collapsed by default) -->
      <div class="settings-section collapsible" id="appearanceSection">
        <div class="collapsible-header" id="appearanceHeader">
          <h3 class="settings-title" style="margin-bottom: 0;">ğŸ¨ Utseende</h3>
          <span class="collapsible-arrow">â€º</span>
        </div>
        <div class="collapsible-content" id="appearanceContent">
          <div class="settings-item">
            <div class="settings-label">
              <span class="settings-icon">ğŸŒ“</span>
              <span>Ljust/MÃ¶rkt</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="darkModeToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="settings-item">
            <div class="settings-label">
              <span class="settings-icon">ğŸ‰</span>
              <span>Helgdagsanimationer</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="holidayAnimationsToggle" checked onchange="toggleHolidayAnimations()">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Fridagsnyckel (collapsible) -->
      <div class="settings-section collapsible" id="fridagsSection">
        <div class="collapsible-header" id="fridagsHeader">
          <h3 class="settings-title" style="margin-bottom: 0;">ğŸ—“ï¸ Fridagsnyckel</h3>
          <span class="collapsible-arrow">â€º</span>
        </div>
        <div class="collapsible-content" id="fridagsContent">
          <div class="fridag-employee-list" id="fridagEmployeeList">
            <!-- Employees with fridagsnyckel dropdowns will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Trafikverket API-nyckel (collapsible) -->
      <div class="settings-section collapsible" id="trafikverketSection">
        <div class="collapsible-header" id="trafikverketHeader">
          <h3 class="settings-title" style="margin-bottom: 0;">ğŸš† Trafikverket API</h3>
          <span class="collapsible-arrow">â€º</span>
        </div>
        <div class="collapsible-content" id="trafikverketContent">
          <p class="settings-hint">KrÃ¤vs fÃ¶r AvgÃ¥ng/Ankomst. Registrera gratis pÃ¥ <a href="https://api.trafikinfo.trafikverket.se/" target="_blank" rel="noopener">trafikinfo.trafikverket.se</a></p>
          <div class="api-key-input-group">
            <input type="text" class="api-key-input" id="trafikverketApiKeyInput" placeholder="Klistra in din API-nyckel" autocomplete="off" spellcheck="false">
            <button class="api-key-save-btn" id="trafikverketApiKeySave">Spara</button>
          </div>
          <p class="api-key-status" id="trafikverketApiKeyStatus"></p>
        </div>
      </div>

      <!-- Dagvy-import (collapsible) -->
      <div class="settings-section collapsible" id="dagvyImportSection">
        <div class="collapsible-header" id="dagvyImportHeader">
          <h3 class="settings-title" style="margin-bottom: 0;">ğŸ“‹ Dagvy-import</h3>
          <span class="collapsible-arrow">â€º</span>
        </div>
        <div class="collapsible-content" id="dagvyImportContent">
          <div class="dagvy-upload-zone" id="dagvyUploadZone">
            <div class="dagvy-upload-icon">ğŸ“</div>
            <p class="dagvy-upload-text">VÃ¤lj dagvy JSON-fil</p>
            <p class="dagvy-upload-hint">eller dra och slÃ¤pp hÃ¤r</p>
            <input type="file" id="dagvyFileInput" accept=".json,application/json" style="display:none">
          </div>
          <div class="dagvy-upload-preview" id="dagvyUploadPreview">
            <div class="dagvy-file-info">
              <span class="dagvy-file-icon">ğŸ“„</span>
              <div class="dagvy-file-details">
                <span class="dagvy-file-name" id="dagvyFileName"></span>
                <span class="dagvy-file-meta" id="dagvyFileMeta"></span>
              </div>
              <button class="dagvy-file-remove" id="dagvyFileRemove">âœ•</button>
            </div>
            <button class="dagvy-upload-btn" id="dagvyUploadBtn">Ladda upp till Firebase</button>
            <div class="dagvy-upload-progress" id="dagvyUploadProgress">
              <div class="dagvy-progress-bar">
                <div class="dagvy-progress-fill" id="dagvyProgressFill"></div>
              </div>
              <span class="dagvy-progress-text" id="dagvyProgressText"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Radera data (collapsible) -->
      <div class="settings-section collapsible" id="deleteDataSection">
        <div class="collapsible-header" id="deleteDataHeader">
          <h3 class="settings-title" style="margin-bottom: 0;">Radera data</h3>
          <span class="collapsible-arrow">â€º</span>
        </div>
        <div class="collapsible-content" id="deleteDataContent">
          <div class="delete-list" id="deleteEmployeeList">
            <!-- Employees will be rendered here -->
          </div>
        </div>
      </div>

      <!-- App version & updates -->
      <div class="settings-section">
        <h3 class="settings-title">Appversion</h3>
        <div class="version-info">
          <p class="version-text" id="versionText">Vem jobbar idag? v4.13.4</p>
          <p class="version-status" id="versionStatus"></p>
        </div>
        <button class="update-btn" id="checkUpdateBtn">
          <span class="update-icon">ğŸ”„</span>
          SÃ¶k efter uppdatering
        </button>
      </div>
    </div>
  </main>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal-card">
      <div class="modal-icon">âš ï¸</div>
      <h3 class="modal-title">Radera data?</h3>
      <p class="modal-text" id="deleteModalText">Vill du radera all data fÃ¶r denna person?</p>
      <p class="modal-warning">Detta gÃ¥r inte att Ã¥ngra.</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="deleteModalCancel">Avbryt</button>
        <button class="modal-btn danger" id="deleteModalConfirm">Radera</button>
      </div>
    </div>
  </div>

  <!-- Month Picker Bottom Sheet -->
  <div class="month-picker-overlay" id="monthPickerOverlay"></div>
  <div class="month-picker-sheet" id="monthPickerSheet">
    <div class="month-picker-handle"></div>
    <div class="month-picker-header">
      <h3>VÃ¤lj mÃ¥nad</h3>
      <button class="month-picker-close" id="monthPickerClose">Ã—</button>
    </div>
    <div class="month-picker-content">
      <!-- Year selector -->
      <div class="year-selector">
        <button class="year-nav-btn" id="yearPrev">â—€</button>
        <span class="year-display" id="yearDisplay">2026</span>
        <button class="year-nav-btn" id="yearNext">â–¶</button>
      </div>
      <!-- Month grid -->
      <div class="month-grid" id="monthGrid">
        <button class="month-btn" data-month="0">Jan</button>
        <button class="month-btn" data-month="1">Feb</button>
        <button class="month-btn" data-month="2">Mar</button>
        <button class="month-btn" data-month="3">Apr</button>
        <button class="month-btn" data-month="4">Maj</button>
        <button class="month-btn" data-month="5">Jun</button>
        <button class="month-btn" data-month="6">Jul</button>
        <button class="month-btn" data-month="7">Aug</button>
        <button class="month-btn" data-month="8">Sep</button>
        <button class="month-btn" data-month="9">Okt</button>
        <button class="month-btn" data-month="10">Nov</button>
        <button class="month-btn" data-month="11">Dec</button>
      </div>
    </div>
    <div class="month-picker-footer">
      <button class="month-picker-btn today" id="monthPickerToday">ğŸ“… Idag</button>
      <button class="month-picker-btn cancel" id="monthPickerCancel">Avbryt</button>
    </div>
  </div>

  <!-- Day Editor Bottom Sheet -->
  <div class="day-editor-overlay" id="dayEditorOverlay"></div>
  <div class="day-editor-sheet" id="dayEditorSheet">
    <div class="day-editor-handle"></div>
    <div class="day-editor-header">
      <h3 id="dayEditorTitle">Redigera dag</h3>
      <button class="day-editor-close" id="dayEditorClose">Ã—</button>
    </div>
    <div class="day-editor-content">
      <!-- Time Section -->
      <div class="day-editor-section">
        <label class="day-editor-label">Tid</label>
        <div class="day-editor-time-row">
          <input type="time" class="day-editor-time-input" id="dayEditorStartTime" placeholder="06:00">
          <span class="day-editor-time-sep">â€“</span>
          <input type="time" class="day-editor-time-input" id="dayEditorEndTime" placeholder="14:30">
        </div>
      </div>

      <!-- Turn Section -->
      <div class="day-editor-section">
        <label class="day-editor-label">Turn</label>
        <input type="text" class="day-editor-turn-input" id="dayEditorTurn" placeholder="T.ex. M104">
      </div>

      <!-- Type Section -->
      <div class="day-editor-section">
        <label class="day-editor-label">Typ</label>
        <div class="day-editor-chips">
          <button class="day-editor-chip chip-fp" data-type="fp">FP</button>
          <button class="day-editor-chip chip-fpv" data-type="fpv">FPV</button>
          <button class="day-editor-chip chip-sem" data-type="semester">Sem</button>
          <button class="day-editor-chip chip-fl" data-type="foraldraledighet">FL</button>
          <button class="day-editor-chip chip-sjuk" data-type="sjuk">Sjuk</button>
          <button class="day-editor-chip chip-ffu" data-type="ffu">FFU</button>
          <button class="day-editor-chip chip-vab" data-type="vab">VAB</button>
          <button class="day-editor-chip chip-clear" data-type="">Rensa</button>
        </div>
      </div>
    </div>
    <div class="day-editor-footer">
      <button class="day-editor-btn cancel" id="dayEditorCancel">Avbryt</button>
      <button class="day-editor-btn save" id="dayEditorSave">ğŸ’¾ Spara</button>
    </div>
  </div>

  <!-- Application Scripts (order matters!) -->
  <script src="js/config.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/schedule.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/dagvy.js"></script>
  <script src="js/departure.js"></script>
  <script src="js/ui-animations.js"></script>
  <script src="js/ui-editors.js"></script>
  <script src="js/ui-fridag.js"></script>
  <script src="js/app.js"></script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);

            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version available - activate it immediately
                  console.log('New version available, updating...');
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
              });
            });
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });

        // Reload page when new service worker takes over
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            console.log('New version activated, reloading...');
            window.location.reload();
          }
        });
      });
    }
  </script>
</body>
</html>
